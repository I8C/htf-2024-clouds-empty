AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  SAM Template for the i8c Hack The Future 2024 Challenge (Team <TeamName>)

Globals:
  Function:
    Timeout: 10
    Tracing: Active

Parameters:
  TeamName:
    Default: Peerlro
    Type: String
  DiscordWebhook:
    Default: https://discordapp.com/api/webhooks/1299045791054303284/xetolM8Wr4vi0fIhUg2qVOnnHPtY7quS8V0PdWJc6ZOUeg4GsMgQnoH41daNQOBt0dgK
    Type: String
  GeminiApiKey:
    Default: AIzaSyAfoV81Fv8JTAggMhQCPqaumR1KguKM92k
    Type: String
  ClickupListId:
    Default: 901507316946
    Type: String
  ClickupApiToken:
    Default: pk_42539853_ZUMPIQAAAGXSRLTGURA9LPUOHW6LLYGV
    Type: String
  MailgunApiKey:
    Default: dc202a456409d71dbc144950f44349bb-79295dd0-e690dd15
    Type: String
  MailgunUrl:
    Default: https://api.mailgun.net/v3/sandbox99346df11b3b43f790ca6f6a3439ee15.mailgun.org/messages
    Type: String
  NasaApiKey:
    Default: MRVfSzANU4wGl74IoTOD0jdxQefgN2hCMoHwI8mv
    Type: String

Resources:
  # Lambda Challenge 1
  Challenge1Lambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: HTF-24-${TeamName}-Lambda-Challenge1
      CodeUri: src/fn-challenge-1/
      Handler: lambda.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          TeamName:
            Ref: TeamName
          DiscordWebhook:
            Ref: DiscordWebhook
      Policies:
        - Statement:
          - Effect: Allow
            Action: events:*
            Resource: '*'
          - Effect: Allow
            Action:
              - 'xray:PutTraceSegments'
              - 'xray:PutTelemetryRecords'
            Resource: '*'
      Tags:
        Owner:
          Ref: TeamName
        Project: HTF24
        Service: Lambda

  # Challenge 1 Lambda Trigger
  EventBridgeToLambdaChallenge1Rule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName:
        Fn::ImportValue: HTF24-i8c-Stack-EventBridgeBusName
      State: ENABLED
      EventPattern:
        source:
          - HTF24
        detail-type:
          - Fn::Sub: ToBeUsedBy-${TeamName}
      Targets:
        - Arn:
            Fn::GetAtt: [ Challenge1Lambda, Arn ]
          Id: Challenge1Lambda
  
  # Challenge 1 Lambda Invoke Permissions
  PermissionForEventBridgeRuleToInvokeChallenge1:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: Challenge1Lambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt: [ EventBridgeToLambdaChallenge1Rule, Arn ]

  # Lambda Challenge 2
  Challenge2Lambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: HTF-24-${TeamName}-Lambda-Challenge2
      CodeUri: src/fn-challenge-2/
      Handler: lambda.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          TeamName:
            Ref: TeamName
          SQS:
            Fn::ImportValue: HTF24-i8c-Stack-SQS
      Policies:
        - Statement:
          - Effect: Allow
            Action: events:*
            Resource: '*'
          - Effect: Allow
            Action:
              - 'xray:PutTraceSegments'
              - 'xray:PutTelemetryRecords'
            Resource: '*'
          - Effect: Allow
            Action: sqs:SendMessage
            Resource: '*'
      Tags:
        Owner:
          Ref: TeamName
        Project: HTF24
        Service: Lambda


  # Challenge 2 Lambda Trigger
  EventBridgeToLambdaChallenge2Rule:
    Type: AWS::Events::Rule
    Properties:
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt: [ Challenge2Lambda, Arn ]
          Id: Challenge2Lambda
      ScheduleExpression: rate(15 minutes)

  # Challenge 2 Lambda Invoke Permissions
  PermissionForEventBridgeRuleToInvokeChallenge2:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: Challenge2Lambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt: [ EventBridgeToLambdaChallenge2Rule, Arn ]

  # Lambda Challenge 3
  Challenge3Lambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: HTF-24-${TeamName}-Lambda-Challenge3
      CodeUri: src/fn-challenge-3/
      Handler: lambda.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          TeamName:
            Ref: TeamName # BucketName automatisch toevoegen aan env variabelen
      Policies:
        - Statement:
          - Effect: Allow
            Action: events:*
            Resource: '*'
          - Effect: Allow
            Action:
              - 'xray:PutTraceSegments'
              - 'xray:PutTelemetryRecords'
            Resource: '*'
          - Effect: Allow
            Action:
              - s3:PutObject
            Resource: '*'
      Tags:
        Owner:
          Ref: TeamName
        Project: HTF24
        Service: Lambda

  # Challenge 3 Lambda Trigger <- Not really needed I think

  # Lambda Challenge 4
  Challenge4Lambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: HTF-24-${TeamName}-Lambda-Challenge4
      CodeUri: src/fn-challenge-4/
      Handler: lambda.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          TeamName:
            Ref: TeamName
          MailgunApiKey:
            Ref: MailgunApiKey
          MailgunUrl:
            Ref: MailgunUrl
          NasaApiKey:
            Ref: NasaApiKey
      Policies:
        - Statement:
          - Effect: Allow
            Action: events:*
            Resource: '*'
          - Effect: Allow
            Action:
              - 'xray:PutTraceSegments'
              - 'xray:PutTelemetryRecords'
            Resource: '*'
      Tags:
        Owner:
          Ref: TeamName
        Project: HTF24
        Service: Lambda

  # Challenge 4 Lambda Trigger <- Not really needed I think

  # Lambda Challenge 5
  Challenge5Lambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: HTF-24-${TeamName}-Lambda-Challenge5
      CodeUri: src/fn-challenge-5/
      Handler: lambda.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          TeamName:
            Ref: TeamName
          GeminiApiKey:
            Ref: GeminiApiKey
          ClickupListId:
            Ref: ClickupListId
          ClickupApiToken:
            Ref: ClickupApiToken
      Policies:
        - Statement:
          - Effect: Allow
            Action: events:*
            Resource: '*'
          - Effect: Allow
            Action:
              - 'xray:PutTraceSegments'
              - 'xray:PutTelemetryRecords'
            Resource: '*'
          - Effect: Allow
            Action:
              - s3:GetObject
            Resource: '*'
      Tags:
        Owner:
          Ref: TeamName
        Project: HTF24
        Service: Lambda

  # Challenge 5 Lambda Permissions <- Not Really needed I think